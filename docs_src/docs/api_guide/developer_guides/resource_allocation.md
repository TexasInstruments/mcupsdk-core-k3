# Modifying resource allocation {#RESOURCE_ALLOCATION_GUIDE}

[TOC]

## Introduction

Various resources of the SOC like the number of DMA channels, number of interrupt router outputs, number of interrupt aggregator virtual interrupt numbers etc. are usually managed by a resource management system or a resource manager.

\cond SOC_AM64X
In the case of AM64x and AM243x devices, this is managed by the System Controller Firmware (SYSFW) running on the M3 core. Once the SYSFW is loaded on M3 and is initialized, we need to send a certain configuration data to the SYSFW regarding the resources we would be using. This is largely an array of resource assignment entries, with each entry specifying the start number of the resource, count or number of resource needed, type of resource, host id of the core which will request for this resource, etc. Later when the request for a specific resource is made, the SYSFW will cross check the request parameters with this already sent configuration data, and the requested resources will only be allocated if that falls within the range in this configuration data. We call this the Resource Management Board Configuration or __RM boardcfg__.
\endcond

\cond SOC_AM62X || SOC_AM62AX || SOC_AM62PX || SOC_AM62DX
In the case of @VAR_SOC_NAME devices, this is managed by the DM Firmware (Divice Manager Firmware) running on the WKUP R5 / DM R5 core. Once the DM firmware is loaded on DM R5 and is initialized, it will read a certain configuration data regarding the resources we would be using. Rom bootloader (RBL) should have loaded this as part of bootflow. This is largely an array of resource assignment entries, with each entry specifying the start number of the resource, count or number of resource needed, type of resource, host id of the core which will request for this resource, etc. Later when the request for a specific resource is made, the DM firmware will cross check the request parameters with this already sent configuration data, and the requested resources will only be allocated if that falls within the range in this configuration data. We call this the Resource Management Board Configuration or __RM boardcfg__.
\endcond

Refer \htmllink{https://software-dl.ti.com/tisci/esd/latest/3_boardcfg/BOARDCFG_RM.html, TISCI documentation} for more details on the RM board configuration.

## Changing a particular resource

- RM Boardcfg is stored in a C file `{SDK_ROOT_DIRECTORY}\source\drivers\sciclient\sciclient_default_boardcfg\`@VAR_SOC_NAME_LOWER`\sciclient_defaultBoardcfg_rm.c`. Ultimately this file needs to be changed
  and rebuilt for the boardcfg change to take effect.
- This file is autogenerated using a SysConfig based GUI tool (K3 Respart Tool). This tool can be invoked from the commandline. To invoke the tool, run the following from the SDK root directory:

\cond SOC_AM62X
```bash
make -s -C tools/sysfw/boardcfg configure SOC=am62x
```
\endcond

\cond SOC_AM62AX
```bash
make -s -C tools/sysfw/boardcfg configure SOC=am62ax
```
\endcond
\cond SOC_AM62PX
```bash
make -s -C tools/sysfw/boardcfg configure SOC=am62px
```
\endcond
\cond SOC_AM62DX
```bash
make -s -C tools/sysfw/boardcfg configure SOC=am62dx
```
\endcond

\imageStyle{respart_tool_main.png,width:50%}
\image html respart_tool_main.png "Resource Partitioning Tool"

- Any changes required for any of the resources can be changed using the GUI and doing a File->Save (Ctrl-S) saves it to a *.syscfg file
  inside the tool.

- Once you have identified for which host you need to assign resources to, and the resource type which you want to modify,
  click on that particular host to see the currently assigned resources

- A host is defined as a logically distinct high level software entity along with a particular security status. This is mostly a
  particular piece of software running on a physical core.

- In the RTOS world this does not have a lot of significance, where mostly it is going to be one piece of software which
  is going to run in a core - be it a bare-metal application or an RTOS based one. In linux/HLOS, it is possible that a
  core has multiple SW entities running, mostly as VMs.

- In a case where a security firmware and the Linux OS is running in the same core, both these SW entities would be considered
  as different hosts, because of the difference in security status.

- Each of these 'hosts' are given an ID by the SYSFW:

- Here is the host id to core mapping:

\cond SOC_AM62X
<table>
<tr>
    <th>HOST ID
    <th>Core
</tr>
<tr>
    <td>TISCI_HOST_ID_TIFS (0U)
    <td>TIFS ARM Cortex M4
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_0 (10U)
    <td>Cortex A53SS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_1 (11U)
    <td>Cortex A53SS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_2 (12U)
    <td>Cortex A53SS0_1 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_3 (13U)
    <td>Cortex A53SS0_1 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_4 (14U)
    <td>Cortex A53SS0_1 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_M4_0 (30U)
    <td>Cortex M4 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_GPU_0 (31U)
    <td>GPU (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_0 (35U)
    <td>Cortex R5FSS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_1 (36U)
    <td>Cortex R5FSS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_2 (37U)
    <td>Cortex R5FSS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_3 (38U)
    <td>Cortex R5FSS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_DM2TIFS (250U)
    <td>DM2TIFS(Secure): DM to TIFS communication
</tr>
<tr>
    <td>TISCI_HOST_ID_TIFS2DM (251U)
    <td>TIFS2DM(Non Secure): TIFS to DM communication
</tr>
<tr>
    <td>TISCI_HOST_ID_HSM (253U)
    <td>HSM (Secure)
</tr>
<tr>
    <td>TISCI_HOST_ID_DM (254U)
    <td>DM(Non Secure): Device Management
</tr>
</table>

Refer \htmllink{https://software-dl.ti.com/tisci/esd/latest/5_soc_doc/am62x/hosts.html, TISCI Host descriptions}

\endcond

\cond SOC_AM62AX || SOC_AM62DX
<table>
<tr>
    <th>HOST ID
    <th>Core
</tr>
<tr>
    <td>TISCI_HOST_ID_TIFS (0U)
    <td>TIFS ARM Cortex M4
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_0 (10U)
    <td>Cortex A53SS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_1 (11U)
    <td>Cortex A53SS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_2 (12U)
    <td>Cortex A53SS0_1 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_3 (13U)
    <td>Cortex A53SS0_1 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_4 (14U)
    <td>Cortex Cortex A53SS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_C7X_0_0 (20U)
    <td>C7X_0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MCU_0_R5_0 (30U)
    <td>Cortex MCU R5 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_0 (35U)
    <td>Cortex R5FSS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_1 (36U)
    <td>Cortex R5FSS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_2 (37U)
    <td>Cortex R5FSS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_3 (38U)
    <td>Cortex R5FSS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_DM2TIFS (250U)
    <td>DM2TIFS(Secure): DM to TIFS communication
</tr>
<tr>
    <td>TISCI_HOST_ID_TIFS2DM (251U)
    <td>TIFS2DM(Non Secure): TIFS to DM communication
</tr>
<tr>
    <td>TISCI_HOST_ID_HSM (253U)
    <td>HSM (Secure)
</tr>
<tr>
    <td>TISCI_HOST_ID_DM (254U)
    <td>DM(Non Secure): Device Management
</tr>
</table>

Refer \htmllink{https://software-dl.ti.com/tisci/esd/latest/5_soc_doc/am62ax/hosts.html, TISCI Host descriptions}

\endcond

\cond SOC_AM62PX
<table>
<tr>
    <th>HOST ID
    <th>Core
</tr>
<tr>
    <td>TISCI_HOST_ID_TIFS (0U)
    <td>TIFS ARM Cortex M4
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_0 (10U)
    <td>Cortex A53SS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_1 (11U)
    <td>Cortex A53SS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_2 (12U)
    <td>Cortex A53SS0_1 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_3 (13U)
    <td>Cortex A53SS0_1 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_A53_4 (14U)
    <td>Cortex Cortex A53SS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MCU_0_R5_0 (30U)
    <td>Cortex MCU R5 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_0 (35U)
    <td>Cortex R5FSS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_1 (36U)
    <td>Cortex R5FSS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_2 (37U)
    <td>Cortex R5FSS0_0 (Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_MAIN_0_R5_3 (38U)
    <td>Cortex R5FSS0_0 (Non-Secure Context)
</tr>
<tr>
    <td>TISCI_HOST_ID_DM2TIFS (250U)
    <td>DM2TIFS(Secure): DM to TIFS communication
</tr>
<tr>
    <td>TISCI_HOST_ID_TIFS2DM (251U)
    <td>TIFS2DM(Non Secure): TIFS to DM communication
</tr>
<tr>
    <td>TISCI_HOST_ID_HSM (253U)
    <td>HSM (Secure)
</tr>
<tr>
    <td>TISCI_HOST_ID_DM (254U)
    <td>DM(Non Secure): Device Management
</tr>
</table>

Refer \htmllink{https://software-dl.ti.com/tisci/esd/latest/5_soc_doc/am62px/hosts.html, TISCI Host descriptions}
\endcond

- For all general purpose use-cases in RTOS, you would want to allocate resources to the
  non-secure host. Secure hosts in RTOS are reserved special softwares like the secondary
  bootloader which would need elevated security privileges to perform actions like
  opening firewalls, booting other cores etc.

\imageStyle{respart_tool_res.png,width:50%}
\image html respart_tool_res.png "Resource Allocation"

- You can decrease/increase the number of resources.There are hard
  restrictions to certain resources. As long as your assignments are within the
  restrictions, you can change the configuration in the way which suits your
  application. The tool will throw an error if any of resources exceed their
  allowed number.

\imageStyle{respart_tool_error.png,width:50%}
\image html respart_tool_error.png "Resource Exceeding Allowed Limits"

- Resources can be shared between hosts, but at most 2 hosts can have the same resource.
  To share a resource, a resource sharing entry needs to be added in the GUI tool.

\imageStyle{respart_tool_sharing_start.png,width:50%}
\image html respart_tool_sharing_start.png "Resource Allocation Entry"

- After the resource is shared, it will show up as an info under the resource.

\imageStyle{respart_tool_sharing.png,width:50%}
\image html respart_tool_sharing.png "Resource Allocation Info"

- To generate the actual C file from this config file, run the following from the
  SDK root directory once you have saved the config in GUI:
\cond SOC_AM62X
```bash
make -s -C tools/sysfw/boardcfg configure-gen SOC=am62x
```
\endcond

\cond SOC_AM62AX
```bash
make -s -C tools/sysfw/boardcfg configure-gen SOC=am62ax
```
\endcond
\cond SOC_AM62PX
```bash
make -s -C tools/sysfw/boardcfg configure-gen SOC=am62px
```
\endcond
\cond SOC_AM62DX
```bash
make -s -C tools/sysfw/boardcfg configure-gen SOC=am62dx
```
\endcond

- That should update the `{SDK_ROOT_DIRECTORY}\source\drivers\sciclient\sciclient_default_boardcfg\{SOC}\sciclient_defaultBoardcfg_rm.c` file.

## Rebuilding the board configuration

- Once the changes are made in the file and sciclient_defaultBoardcfg_rm.c is generated, Re-build the boardcfg binary blob by running the following from SDK root directory:

\cond SOC_AM62X
```bash
make -s -C tools/sysfw/boardcfg sciclient_boardcfg SOC=am62x
```
\endcond
\cond SOC_AM62AX
```bash
make -s -C tools/sysfw/boardcfg sciclient_boardcfg SOC=am62ax
```
\endcond
\cond SOC_AM62PX
```bash
make -s -C tools/sysfw/boardcfg sciclient_boardcfg SOC=am62px
```
\endcond
\cond SOC_AM62DX
```bash
make -s -C tools/sysfw/boardcfg sciclient_boardcfg SOC=am62dx
```
\endcond

