# SBL Booting Linux From OSPI {#SBL_BOOTING_LINUX_OSPI}

[TOC]

## Introduction
\cond SOC_AM64X
- SBL booting Linux (see \ref EXAMPLES_DRIVERS_SBL_OSPI_LINUX) is a secondary bootloader application that boots Linux on A53 core and RTOS/NORTOS application on R5, M4 cores.
\endcond
\cond SOC_AM62X
- SBL booting Linux (see \ref EXAMPLES_DRIVERS_SBL_OSPI_LINUX_MULTISTAGE) is a secondary bootloader application that boots Linux on A53 core and RTOS/NORTOS application on R5, M4 cores.
\endcond
\cond SOC_AM62AX
- SBL booting Linux (\ref EXAMPLES_DRIVERS_SBL_OSPI_NAND_LINUX_MULTISTAGE) is a secondary bootloader application that boots Linux on A53 core and RTOS/NORTOS application on R5, MCU-R5 and C75 cores.
\endcond
\cond SOC_AM62PX
- SBL booting Linux (\ref EXAMPLES_DRIVERS_SBL_OSPI_LINUX_MULTISTAGE) is a secondary bootloader application that boots Linux on A53 core and RTOS/NORTOS application on R5, MCU-R5 cores.
\endcond

\cond SOC_AM64X
- The bootloader makes use of two appimages
    - One containing the application images(RTOS/NORTOS) for R5, M4 cores
    - Other containing the Linux binaries(ATF, OPTEE, SPL) for A53 core.
\endcond
\cond SOC_AM62X
- The bootloader makes use of 6 appimages
    - A Linux appimage containing the **Linux binaries (ATF, OPTEE, A53 SPL)**.
    - tiboot3.bin with **SBL stage1, TIFS, BoardConfig**
    - Appimage for **SBL stage2**
    - Appimage for **MCU M4**
    - Appimage for **HSM M4**
    - DM firmware appimage for **DM R5**
- Boots R5F, MCU-M4, HSM-M4 cores and Linux on A53 from OSPI.
- SBL booting Linux can be used when early booting of R5F, HSM-M4 and MCU-M4 cores are required. When using uBoot, the application will start running on R5F, HSM-M4 and MCU-M4 cores only after booting Linux
\endcond
\cond SOC_AM62AX

- The bootloader makes use of 7 appimages
    - A Linux appimage containing the **Linux binaries (ATF, OPTEE, A53 SPL)**.
    - tiboot3.bin with **SBL stage1, TIFS, BoardConfig**
    - Appimage for **SBL stage2**
    - Appimage for **MCU R5**
    - Appimage for **HSM M4**
    - Appimage for **C75**
    - DM firmware appimage for **DM R5**
- Boots R5F, MCU-R5, HSM-M4, C75 cores and Linux on A53 from OSPI.
- SBL booting Linux can be used when early booting of R5F, HSM-M4, C75 and MCU-R5 cores are required. When using uBoot, the application will start running on R5F, HSM-M4, C75 and MCU-R5 cores only after booting Linux
\endcond
\cond SOC_AM62PX

- The bootloader makes use of 5 appimages
    - A Linux appimage containing the **Linux binaries (ATF, OPTEE, A53 SPL)**.
    - tiboot3.bin with **SBL stage1, TIFS, BoardConfig**
    - Appimage for **WKUP R5 with SBL stage2**
    - Appimage for **MCU R5**
    - Appimage for **HSM M4**
- Boots WKUP-R5F, MCU-R5, HSM-M4 cores and Linux on A53 from OSPI.
- SBL booting Linux can be used when early booting of WKUP-R5F, HSM-M4 and MCU-R5 cores are required. When using uBoot, the application will start running on WKUP-R5F, HSM-M4 and MCU-R5 cores only after booting Linux.
\endcond
- The Linux appimage can be generated by using \ref LINUX_APPIMAGE_GEN_TOOL
- The appimages will be flashed to the offset specified by SysCfg, the SBL parses the appimages from these locations, loads and run the cores.

## Bootflow for SBL booting linux from OSPI

\cond SOC_AM62AX
\note The binaries for R5F, M4F, C75 cores need not be in the linux root partition `(root/lib/firmware)`, when SBL is booting Linux.
\endcond
\cond SOC_AM62PX
\note The binaries for WKUP-R5F, MCU-R5 cores need not be in the linux root partition `(root/lib/firmware)`, when SBL is booting Linux.
\endcond
\cond SOC_AM62X
\note The binaries for R5F, M4F cores need not be in the linux root partition `(root/lib/firmware)`, when SBL is booting Linux.
\endcond
\cond SOC_AM64X
- The bootflow for SBL booting Linux is as follows

    \imageStyle{sbl_booting_linux_ospi.png,width:60%}
    \image html sbl_booting_linux_ospi.png "Bootflow for SBL booting Linux"
\endcond

\cond SOC_AM62X
- The bootflow for SBL booting Linux is as follows

    \imageStyle{sbl_booting_linux_ospi_am62x.png,width:60%}
    \image html sbl_booting_linux_ospi_am62x.png "Bootflow for SBL booting Linux"
\endcond

\cond SOC_AM62AX
- The bootflow for SBL booting Linux is as follows

    \imageStyle{sbl_booting_linux_ospi_am62ax_2stage.png,width:60%}
    \image html sbl_booting_linux_ospi_am62ax_2stage.png "Bootflow for multi-stage SBL booting Linux "

\endcond

\cond SOC_AM62PX
- The bootflow for SBL booting Linux is as follows

    \imageStyle{sbl_booting_linux_ospi_am62px_2stage.png,width:70%}
    \image html sbl_booting_linux_ospi_am62px_2stage.png "Bootflow for multi-stage SBL booting Linux "

- The stage 2 bootloader and the Device manager application are combined as a single appimage
- The SBL stage 1 will self load SBL stage 2 + Device manager application to WKUP-R5 core and run self CPU
- Then two threads namely, main thread and SBL stage 2 thread will be created for parallel execution
- The main thread will open the drivers required for application, do the SciServer init and run the WKUP-R5 core application
- The SBL thread will set the clock and open the drivers for the peripherals used by the SBL.
- Then it boots the HSM-M4 core, MCU-R5 core and linux on A53 core.

\note - The peripherals used by SBL and application are separated by using the sysconfig option 'Instance added by bootloader'.
\note - For the peripherals used by SBL, the 'Instance added by bootloader' option is enabled in the sysconfig as shown.

\note     \imageStyle{sysconfig_option_addedbybootloader.png,width:50%}
\note     \image html sysconfig_option_addedbybootloader.png "Instance added by bootloader - sysconfig option"

\note - These peripherals will be opened/closed in the SBL thread and it will not get opened/closed in the common Drivers_open/Drivers_close function called in
the main thread.

\endcond

\cond SOC_AM64X
## SRAM memory layout for SBL booting Linux

\note The memory load address for core applications must not overlap with one other
\attention The load address for R5 and M4 core applications must be consistant with the memory layout in Linux dts

- Shown below is the memory map in SRAM for SBL booting Linux

    \imageStyle{sram_memory_map.png,width:20%}
    \image html sram_memory_map.png "SRAM memory map for SBL booting Linux"
\endcond

## OSPI memory layout for SBL booting Linux from OSPI

\cond !SOC_AM62AX
\note The flash address R5F, M4F appimages and Linux appimages can be configured using Syscfg
\endcond

\cond SOC_AM62AX
\note The flash address RF5, MCU-R5F, C75, HSM-M4  and Linux appimages can be configured using Syscfg
\endcond

\cond SOC_AM62PX
\note The flash address RF5, MCU-R5F, HSM-M4 and Linux appimages can be configured using Syscfg
\endcond

\cond SOC_AM64X
- The default OSPI flash location is as below

    \imageStyle{ospi_memory_layout.png,width:20%}
    \image html ospi_memory_layout.png "OSPI memory map for SBL booting Linux"
\endcond

\cond SOC_AM62X
\code
      0x0 +----------------------------+
          |      tiboot3.bin           |
          | (SBL stage1,TIFS,boardcfg) |
          |                            |
  0x80000 +----------------------------+
          |      SBL Stage2            |
          |                            |
 0x100000 +----------------------------+
          |     MCU M4 App Image       |
          |                            |
 0x280000 +----------------------------+
          |     ospi.u-boot(4m)        |
          |                            |
 0x680000 +----------------------------+
          |     ospi.env(128k)         |
          |                            |
 0x6c0000 +----------------------------+
          |   ospi.env.backup(128k)    |
          |                            |
 0x740000 +----------------------------+
          |      padding (768k)        |
 0x800000 +----------------------------+
          |      HSM App Image         |
          |                            |
 0xA00000 +----------------------------+
          |      DM App Image          |
          |                            |
 0xC00000 +----------------------------+
          |      Linux App Image       |
          |                            |
0x3fc0000 +----------------------------+
          |   ospi.phypattern (256k)   |
          |                            |
          +----------------------------+
\endcode
\endcond


\cond SOC_AM62AX

\code
       0x0 +----------------------------+
           |      tiboot3.bin           |
           | (SBL stage1,TIFS,boardcfg) |
           |                            |
   0x80000 +----------------------------+
           |       SBL Stage2           |
           |                            |
   0xC0000 +----------------------------+
           |      DM App Image          |
           |                            |
  0x240000 +----------------------------+
           |      HSM App Image         |
           |                            |
  0x280000 +----------------------------+
           |     ospi.u-boot(4m)        |
           |                            |
  0x800000 +----------------------------+
           |     MCU R5 App Image       |
           |                            |
  0xA00000 +----------------------------+
           |      C75 App Image         |
           |                            |
 0x1200000 +----------------------------+
           |      Linux App Image       |
           |                            |
           +----------------------------+
\endcode
\endcond


\cond SOC_AM62PX

\code
       0x0 +----------------------------+
           |      tiboot3.bin           |
           | (SBL stage1,TIFS,boardcfg) |
           |                            |
   0x80000 +----------------------------+
           |   SBL Stage2 + DM Image    |
           |                            |
  0x240000 +----------------------------+
           |      HSM App Image         |
           |                            |
  0x280000 +----------------------------+
           |     ospi.u-boot(4m)        |
           |                            |
  0x800000 +----------------------------+
           |     MCU R5 App Image       |
           |                            |
 0x1200000 +----------------------------+
           |      Linux App Image       |
           |                            |
           +----------------------------+
\endcode
\endcond
## SD card Partitioning
\cond SOC_AM64X
\note The default SD card image for AM64x-evm can be used to boot Linux using SBL
\note The tiboot3.bin, tispl.bin will not be used for booting Linux when using SBL booting Linux.
\note The R5 binaries in the root partition (eg : `root/lib/firmware/am64-main-r5f0_0-fw`) will not be used when SBL boots Linux and R5,M4 cores.

The default Linux SD card image for AM64x-evm has two partitons
\endcond

\cond SOC_AM62X
\note The default SD card image for am62xx-evm can be used to boot Linux using SBL
\note The tiboot3.bin, tispl.bin, u-boot.img will not be used for booting Linux when using SBL booting Linux.
\note U-boot needs to be flashed at the flash device only.
\note The M4 binaries in the root partition (eg : `root/lib/firmware/am62-m4f0_0-fw`) will not be used when SBL boots Linux and R5,M4 cores.

The default Linux SD card image for am62x-sk has two partitons. No files from `boot` partition will be used while booting from OSPI flash device.
\endcond

\cond SOC_AM62AX
\note The default SD card image for AM62Ax-evm can be used to boot Linux using SBL
\note The tiboot3.bin, tispl.bin, u-boot.img will not be used for booting Linux when using SBL booting Linux.
\note U-boot needs to be flashed at the flash device only.
\note The R5 binaries in the root partition (eg : `root/lib/firmware/am62a-mcu-r5f0_0-fw`) will not be used when SBL boots Linux and R5 cores.

The default Linux SD card image for am62ax-sk  has two partitons. No files from `boot` partition will be used while booting from OSPI flash device.
\endcond

\cond SOC_AM62PX
\note The default SD card image for AM62Px-evm can be used to boot Linux using SBL
\note The tiboot3.bin, tispl.bin, u-boot.img will not be used for booting Linux when using SBL booting Linux.
\note U-boot needs to be flashed at the flash device only.
\note The R5 binaries in the root partition (eg : `root/lib/firmware/am62p-mcu-r5f0_0-fw`) will not be used when SBL boots Linux and R5 cores.

The default Linux SD card image for am62px-sk  has two partitons. No files from `boot` partition will be used while booting from OSPI flash device.
\endcond
- A FAT partition (boot) contatining
    - tiboot3.bin
    - tispl.bin
    - u-boot.img
    - uboot.env
- A ext4 partition (root) containing
    - Linux Kernel image
    - Linux DTB
    - Linux file system

## See Also
\cond SOC_AM64X
- \ref EXAMPLES_DRIVERS_SBL_OSPI_LINUX
\endcond
\cond SOC_AM62X
- \ref EXAMPLES_DRIVERS_SBL_OSPI_LINUX_MULTISTAGE
- \ref EXAMPLES_DRIVERS_SBL_OSPI_NAND_LINUX_MULTISTAGE
\endcond
\cond SOC_AM62PX
- \ref EXAMPLES_DRIVERS_SBL_OSPI_LINUX_MULTISTAGE
\endcond
\cond SOC_AM62AX
- \ref EXAMPLES_DRIVERS_SBL_OSPI_NAND_LINUX_MULTISTAGE
\endcond
- \ref LINUX_APPIMAGE_GEN_TOOL